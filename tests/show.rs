use crate::common::with_temp_data_dir;
use common::Benchie;
use lazy_static::lazy_static;

mod common;

lazy_static! {
    static ref BENCHIE: Benchie = Benchie::new();
}

#[test]
fn show_command_is_deterministic_and_sorted() {
    with_temp_data_dir(|dir| {
        (0..10).into_iter().for_each(|_| {
            let output = BENCHIE.run_in_dir(&["show"], dir.path());

            assert_eq!(output, SHOW_OUTPUT);
        });
    })
}

const SHOW_OUTPUT: &str = "Basic information about all your 9 saved benchmarks:
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| key             | occurrences | example values                                                                                     |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| algorithm       | 9           | mergesort, bubblesort                                                                              |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| arch            | 9           | aarch64                                                                                            |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| benchie_version | 9           | 0.3.0                                                                                              |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| branch          | 9           | fix-git-info-without-head                                                                          |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| command         | 9           | ls                                                                                                 |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| commit_id       | 9           | 68eb6afe20239352f5457c0577b797530c1f6ab2                                                           |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| commit_message  | 9           | remove dead code                                                                                   |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| cores           | 9           | 8                                                                                                  |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| created_at      | 9           | 2022-05-14 20:30:32.032275 UTC, 2022-05-14 20:30:27.649552 UTC, 2022-05-14 20:30:26.774221 UTC,... |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| elements        | 9           | 1000, 10, 100,...                                                                                  |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| is_dirty        | 9           | false                                                                                              |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| kernel_version  | 9           | 21.4.0                                                                                             |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| os              | 9           | macos                                                                                              |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| os_family       | 9           | unix                                                                                               |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| os_version      | 9           | 12.3.1                                                                                             |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| real_time       | 9           | 1.867041ms, 1.737ms, 1.907833ms,...                                                                |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| status_code     | 9           | 0                                                                                                  |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| system_time     | 9           | 725µs, 706µs, 676µs,...                                                                            |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| total_memory    | 9           | 17.2 GB                                                                                            |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| total_swap      | 9           | 2.1 GB                                                                                             |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| used_memory     | 9           | 17.0 GB, 17.0 GB, 17.0 GB,...                                                                      |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| used_swap       | 9           | 765.5 MB                                                                                           |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+
| user_time       | 9           | 365µs, 390µs, 362µs,...                                                                            |
+-----------------+-------------+----------------------------------------------------------------------------------------------------+

";

#[test]
fn show_1d_table_works() {
    with_temp_data_dir(|dir| {
        let output = BENCHIE.run_in_dir(&["show", "--row", "algorithm", "real_time"], dir.path());

        assert_eq!(output, SHOW_1D_TABLE_OUTPUT);
    })
}

const SHOW_1D_TABLE_OUTPUT: &str = "Showing 1-dimensional table with:
row: algorithm, metric: real_time

+------------+------------+
| algorithm  | real_time  |
+------------+------------+
| bubblesort | 2.831041ms |
+------------+------------+
| bubblesort | 2.162333ms |
+------------+------------+
| bubblesort | 2.007625ms |
+------------+------------+
| bubblesort |    1.755ms |
+------------+------------+
| mergesort  | 1.531333ms |
+------------+------------+
| mergesort  | 1.735208ms |
+------------+------------+
| mergesort  | 1.907833ms |
+------------+------------+
| mergesort  |    1.737ms |
+------------+------------+
| mergesort  | 1.867041ms |
+------------+------------+

";

#[test]
fn show_2d_table_works() {
    with_temp_data_dir(|dir| {
        let output = BENCHIE.run_in_dir(
            &[
                "show",
                "--row",
                "algorithm",
                "--col",
                "elements",
                "real_time",
            ],
            dir.path(),
        );

        assert_eq!(output, SHOW_2D_TABLE_OUTPUT);
    })
}

const SHOW_2D_TABLE_OUTPUT: &str = "Showing 2-dimensional table with:
row: algorithm, col: elements, metric: real_time

+------------+--------------------------+--------------------------+------------+
|            | 10                       | 100                      | 1000       |
+------------+--------------------------+--------------------------+------------+
| bubblesort | {2.831041ms, 2.162333ms} | {2.007625ms, 1.755ms}    |            |
+------------+--------------------------+--------------------------+------------+
| mergesort  | {1.907833ms, 1.737ms}    | {1.531333ms, 1.735208ms} | 1.867041ms |
+------------+--------------------------+--------------------------+------------+

";
